<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
	<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
	<title></title>
	<meta name="generator" content="LibreOffice 5.0.3.2 (Linux)"/>
	<meta name="author" content="Tom "/>
	<meta name="created" content="2017-12-23T11:47:48"/>
	<meta name="changedby" content="Tom "/>
	<meta name="changed" content="2018-01-26T09:04:50.826311546"/>
	<style type="text/css">
		@page { margin: 0.79in }
		p { margin-bottom: 0.1in; direction: ltr; color: #00000a; line-height: 120%; text-align: left; orphans: 0; widows: 0 }
		p.western { font-family: "Liberation Serif", serif; font-size: 12pt; so-language: en-US }
		p.cjk { font-family: "Droid Sans Fallback"; font-size: 12pt; so-language: zh-CN }
		p.ctl { font-family: "FreeSans"; font-size: 12pt; so-language: hi-IN }
		p.egcode-western { margin-left: 0.02in; margin-bottom: 0in; font-family: "Courier 10 Pitch", serif; font-size: 10pt; so-language: en-US }
		p.egcode-cjk { margin-left: 0.02in; margin-bottom: 0in; font-family: "Droid Sans Fallback"; font-size: 10pt; so-language: zh-CN }
		p.egcode-ctl { margin-left: 0.02in; margin-bottom: 0in; font-family: "FreeSans"; font-size: 12pt; so-language: hi-IN }
		a:link { so-language: zxx }
	</style>
</head>
<body lang="en-US" text="#00000a" dir="ltr">
<p align="center" style="margin-top: 0.7in; margin-bottom: 0.16in; line-height: 100%">
<font size="4" style="font-size: 14pt"><b>The new classical tiny-C</b></font></p>
<p align="center" style="text-indent: 0.01in; margin-bottom: 0.5in; line-height: 100%">
<b>Thomas A. Gibson</b></p>
<p align="center" style="margin-bottom: 0in; line-height: 100%">January
7, 2018</p>
<p style="margin-top: 0.3in; margin-bottom: 0.1in; line-height: 100%">
<font face="Arial, serif"><font size="4" style="font-size: 14pt"><b>Introduction</b></font></font></p>
<p class="western">This writing serves two purposes. The body
documents the product focusing on both usage and internals. It
assumes knowledge of C, so on that subject it is terse, documenting
the subset and differences. The internals includes a debugging
technique, the test system, and machine calls. I am inviting you to
both use and extend this work. 
</p>
<p class="western">The appendices have related writings, or links to
them: implementation, motivation, source documents, stories, and
more. If you are installing this code, or porting to a different
environment be sure to read Appendix B. There is a bit of history,
tiny-C Stories for example, which explains why I varied from a strict
subset of C, and other decisions. And source documents includes the
original 8080 assembler code for the 1977 CP/M version.</p>
<p class="western">The word CURRENTLY in all caps is a flag for me
(or you if you would like) to someday do the modest  enhancement
implied.</p>
<p style="margin-top: 0.3in; margin-bottom: 0.1in; line-height: 100%">
<font face="Arial, serif"><font size="4" style="font-size: 14pt"><b>The
Language</b></font></font></p>
<p style="margin-top: 0.1in; margin-bottom: 0.1in; line-height: 100%">
<font color="#000000"><font face="Liberation Serif, Times New Roman, serif"><font size="4" style="font-size: 14pt"><i><b>Man
page</b></i></font></font></font></p>
<p class="western">NAME</p>
<p class="western">       tiny-C – classic 1977 tiny-C interpreter
reimplemented in C, and GPL'd</p>
<p class="western">SYNOPSIS</p>
<p class="western">       tinyc [ -d ] [LIBRARY] FILE</p>
<p class="western">DESCRIPTION</p>
<p class="western">       Execute the tiny-C program in FILE using
LIBRARY. Default library is pps/library.tc.</p>
<p class="western">OPTIONS</p>
<p class="western">        -d    debug mode</p>
<p style="margin-top: 0.1in; margin-bottom: 0.1in; line-height: 100%">
<font color="#000000"><font face="Liberation Serif, Times New Roman, serif"><font size="4" style="font-size: 14pt"><i><b>Syntax</b></i></font></font></font></p>
<p class="western">Tiny-C's syntax is a lazy adaptation of the C
syntax. The motivation for the variance is described in Stories, #3.
The differences…</p>
<ol>
	<li/>
<p class="western">Comments begin with /* and end at the end
	of the line. CURRENTLY // is planned but not implemented.</p>
	<li/>
<p class="western">Function and variable names are internally
	canonicalized to the first 7 plus the last character. They are case
	sensitive.</p>
	<li/>
<p class="western">Reserved names: <font face="Courier 10 Pitch, serif">if,
	else, while, return, break, char, int, MC, endlibrary</font></p>
	<li/>
<p class="western">Data: <font face="Courier 10 Pitch, serif">int,
	char</font>, one dimensional array of either. An array of dimension
	N has size N+1. The array syntax uses ()'s instead of []'s. So <font face="Courier 10 Pitch, serif">char
	player(9)</font> has 10 elements, from player(0) to player(9). An
	int is signed 32 bit. Array names can be used as pointers. So
	player+3 will point to player[3]. And they are lvalue's, e.g.
	<font face="Courier 10 Pitch, serif">player=</font>something.</p>
	<li/>
<p class="western">Locals and Globals. All functions and all
	data not declared within a function are global. One required global
	is the application function <font face="Courier 10 Pitch, serif">main()</font>.
	This differs from the 1977 tiny-C.</p>
	<li/>
<p class="western">Library variables are all global variables
	before the special global word <font face="Courier 10 Pitch, serif">endlibrary</font>.
	Look at the end of the supplied library for this use.  A symbol
	(data or function) is looked up in this order: locals, globals,
	library.</p>
	<li/>
<p class="western">Operators:    <font face="Courier 10 Pitch, serif">+
	 -  *  /  %  &lt;  &gt;  &lt;=  &gt;=  ==  !=  =</font></p>
	<li/>
<p class="western">Expressions:  The top level expression
	parse is assignment. Then relation, etc, down to factor and
	constant, the same as C. So   <font face="Courier 10 Pitch, serif">while(
	k=(k+1)&lt;MAXK ) [..code..]</font>    works just fine.</p>
	<li/>
<p class="western">Functions: Function bodies use <font face="Courier 10 Pitch, serif">[]
	</font>instead of <font face="Courier 10 Pitch, serif">{ }</font>.
	Parenthesis are optional for arguments provided the function is the
	last of an expression. So  <font face="Courier 10 Pitch, serif"><span style="font-style: normal"><span style="font-weight: normal">foobar</span></span></font><font face="Courier 10 Pitch, serif">
	data, another</font>  is the same as  <font face="Courier 10 Pitch, serif">foobar(data,another).
	</font>But that comma is required even in the first form. And 
	<font face="Courier 10 Pitch, serif">number=gn </font>is fine, but
	<font face="Courier 10 Pitch, serif">number=(gn()+10)/2 </font>requires
	the <font face="Courier 10 Pitch, serif">()</font>.</p>
	<li/>
<p class="western">Newlines and semicolon separates
	statements. So <font face="Courier 10 Pitch, serif">hello; goodbye;
	seeYa tomorrow </font>calls hello, calls goodbye, calls
	seeYa(tomorrow).</p>
	<li/>
<p class="western">Statements: <font face="Courier 10 Pitch, serif">if,
	else, while, return, break. </font>If, else and while bodies use <font face="Courier 10 Pitch, serif">[]</font>s
	instead of <font face="Courier 10 Pitch, serif">{}</font>s.</p>
	<li/>
<p class="western">No semicolon required for the last
	statement on a line, as the end-of-line (or beginning of a comment)
	also ends the statement. Semicolons also separate statements, so
	multiple statements can be on one line.</p>
</ol>
<p style="margin-top: 0.1in; margin-bottom: 0.1in; line-height: 100%">
<font color="#000000"><font face="Liberation Serif, Times New Roman, serif"><font size="4" style="font-size: 14pt"><i><b>Library</b></i></font></font></font></p>
<p class="western">The standard library is in the file
<font face="Courier 10 Pitch, serif">pps/library.tc</font>, and is
written in tiny-C. CURRENTLY the function definitions are in comments
preceding each function, but will be here someday.</p>
<p style="margin-top: 0.3in; margin-bottom: 0.1in; line-height: 100%">
<font face="Arial, serif"><font size="4" style="font-size: 14pt"><b>Debugger</b></font></font></p>
<p style="margin-top: 0.1in; margin-bottom: 0.1in; line-height: 100%">
<font color="#000000"><font face="Liberation Serif, Times New Roman, serif"><font size="4" style="font-size: 14pt"><i><b>Normal
Usage, examining behavior of tinyC code</b></i></font></font></font></p>
<p class="western">To use the debugger, start tiny-C with the -d
option:</p>
<p class="western">	<font face="Courier 10 Pitch, serif">$ tinyC -d
&lt;filename&gt;</font></p>
<p class="western">You will get a debug prompt</p>
<p class="western">	<font face="Courier 10 Pitch, serif">(db-tc)</font></p>
<p class="western">The commands are single letters, space (optional),
single argument (for some commands)</p>
<table width="665" cellpadding="3" cellspacing="0">
	<col width="131">
	<col width="520">
	<tr valign="top">
		<td width="131" bgcolor="#ffffff" style="border-top: 1px solid #000001; border-bottom: 1px solid #000001; border-left: 1px solid #000001; border-right: none; padding-top: 0.04in; padding-bottom: 0.04in; padding-left: 0.04in; padding-right: 0in">
			<p class="western"><font face="Courier 10 Pitch, serif">b &lt;symbol&gt;</font></p>
		</td>
		<td width="520" bgcolor="#ffffff" style="border: 1px solid #000001; padding-top: 0.04in; padding-bottom: 0.04in; padding-left: 0.04in; padding-right: 0.04in">
			<p class="western">set a breakpoint at the in-scope symbol.
			CURRENTLY: the symbol must be in canonical form, first seven
			letters plus the last.</p>
		</td>
	</tr>
	<tr valign="top">
		<td width="131" bgcolor="#ffffff" style="border-top: 1px solid #000001; border-bottom: 1px solid #000001; border-left: 1px solid #000001; border-right: none; padding-top: 0.04in; padding-bottom: 0.04in; padding-left: 0.04in; padding-right: 0in">
			<p class="western"><font face="Courier 10 Pitch, serif">i [b]</font></p>
		</td>
		<td width="520" bgcolor="#ffffff" style="border: 1px solid #000001; padding-top: 0.04in; padding-bottom: 0.04in; padding-left: 0.04in; padding-right: 0.04in">
			<p class="western">information: CURRENTLY only a list of
			breakpoints and their state</p>
		</td>
	</tr>
	<tr valign="top">
		<td width="131" bgcolor="#ffffff" style="border-top: 1px solid #000001; border-bottom: 1px solid #000001; border-left: 1px solid #000001; border-right: none; padding-top: 0.04in; padding-bottom: 0.04in; padding-left: 0.04in; padding-right: 0in">
			<p class="western"><font face="Courier 10 Pitch, serif">r</font></p>
		</td>
		<td width="520" bgcolor="#ffffff" style="border: 1px solid #000001; padding-top: 0.04in; padding-bottom: 0.04in; padding-left: 0.04in; padding-right: 0.04in">
			<p class="western">run the program from the beginning.  CURRENTLY
			same as c (continue) except for its first use to start the run.</p>
		</td>
	</tr>
	<tr valign="top">
		<td width="131" bgcolor="#ffffff" style="border-top: 1px solid #000001; border-bottom: 1px solid #000001; border-left: 1px solid #000001; border-right: none; padding-top: 0.04in; padding-bottom: 0.04in; padding-left: 0.04in; padding-right: 0in">
			<p class="western"><font face="Courier 10 Pitch, serif">p
			&lt;variable&gt;</font></p>
		</td>
		<td width="520" bgcolor="#ffffff" style="border: 1px solid #000001; padding-top: 0.04in; padding-bottom: 0.04in; padding-left: 0.04in; padding-right: 0.04in">
			<p class="western">print the value of the in-scope variable</p>
		</td>
	</tr>
	<tr valign="top">
		<td width="131" bgcolor="#ffffff" style="border-top: 1px solid #000001; border-bottom: 1px solid #000001; border-left: 1px solid #000001; border-right: none; padding-top: 0.04in; padding-bottom: 0.04in; padding-left: 0.04in; padding-right: 0in">
			<p class="western"><font face="Courier 10 Pitch, serif">n</font></p>
		</td>
		<td width="520" bgcolor="#ffffff" style="border: 1px solid #000001; padding-top: 0.04in; padding-bottom: 0.04in; padding-left: 0.04in; padding-right: 0.04in">
			<p class="western">next statement.</p>
		</td>
	</tr>
	<tr valign="top">
		<td width="131" bgcolor="#ffffff" style="border-top: 1px solid #000001; border-bottom: 1px solid #000001; border-left: 1px solid #000001; border-right: none; padding-top: 0.04in; padding-bottom: 0.04in; padding-left: 0.04in; padding-right: 0in">
			<p class="western"><font face="Courier 10 Pitch, serif">c</font></p>
		</td>
		<td width="520" bgcolor="#ffffff" style="border: 1px solid #000001; padding-top: 0.04in; padding-bottom: 0.04in; padding-left: 0.04in; padding-right: 0.04in">
			<p class="western">continue running to next breakpoint.</p>
		</td>
	</tr>
	<tr valign="top">
		<td width="131" bgcolor="#ffffff" style="border-top: 1px solid #000001; border-bottom: 1px solid #000001; border-left: 1px solid #000001; border-right: none; padding-top: 0.04in; padding-bottom: 0.04in; padding-left: 0.04in; padding-right: 0in">
			<p class="western"><font face="Courier 10 Pitch, serif">x</font></p>
		</td>
		<td width="520" bgcolor="#ffffff" style="border: 1px solid #000001; padding-top: 0.04in; padding-bottom: 0.04in; padding-left: 0.04in; padding-right: 0.04in">
			<p class="western">exit the interpreter, printing the final
			status.</p>
		</td>
	</tr>
	<tr valign="top">
		<td width="131" bgcolor="#ffffff" style="border-top: 1px solid #000001; border-bottom: 1px solid #000001; border-left: 1px solid #000001; border-right: none; padding-top: 0.04in; padding-bottom: 0.04in; padding-left: 0.04in; padding-right: 0in">
			<p class="western"><font face="Courier 10 Pitch, serif">g</font></p>
		</td>
		<td width="520" bgcolor="#ffffff" style="border: 1px solid #000001; padding-top: 0.04in; padding-bottom: 0.04in; padding-left: 0.04in; padding-right: 0.04in">
			<p class="western">go to debugger under which the interpreter is
			running, e.g. to (gdb). See the section documenting this feature.
			Used to find interpreter bugs.</p>
		</td>
	</tr>
</table>
<p class="western"><br/>
<br/>

</p>
<p style="margin-bottom: 0in; line-height: 100%; page-break-after: avoid">
<b>Usage notes</b></p>
<p class="western">This tiny debugger is motivated by my experience
with gnu's C/C++ debug, gdb. Seven commands mimic those of gdb, but
there are differences.</p>
<p class="western">Breakpoints are set on symbols that must be in
scope. That usually means globals, but locals provided their
declaration has been processed. All function names are global, so
they can always be breakpointed. Any occurrence of that symbol causes
the debugger to be entered before the symbol is processed. The prompt
<font face="Courier 10 Pitch, serif">(db-tc)</font> is displayed and
you can enter any of the above commands. Use the <font face="Courier 10 Pitch, serif">c</font>
command to continue running. CURRENTLY the <font face="Courier 10 Pitch, serif">r</font>
command also continues running but it should offer a query to
restart.</p>
<p class="western">Information with or without the <font face="Courier 10 Pitch, serif">b</font>
argument prints a table of current breakpoints. Note that a
breakpoint on a local that goes out of scope will disappear from the
table. It will not reappear if the function is re-entered, and if
needed must be reset. CURRENTLY enabled is always 'y' (yes).
CURRENTLY hits are not counted. CURRENTLY the <font face="Courier 10 Pitch, serif">v</font>
option (print names of in-scope variables) is unavailable.</p>
<p class="western">Print a variable is probably the most useful
command. Its value is displayed. CURRENTLY arrays are fully printed,
so it is best to keep their dimensions small until debugging is
complete.</p>
<p class="western">Run starts or continues the already loaded tiny-C
program. No argument is needed. CURRENTLY it does not offer the
restart option, so a second use of <font face="Courier 10 Pitch, serif">r</font>
does a continue.</p>
<p class="western">Next does the next statement. This differs from
gdb which does the next line with an executable. The interpreter is
statement oriented, not line oriented.</p>
<p class="western">Continue continues execution until another break
occurs, or the program ends. If the program ends on an error it is
printed, and the interpreter exits.</p>
<p class="western">Exit terminates interpreter execution.</p>
<p style="margin-top: 0.1in; margin-bottom: 0.1in; line-height: 100%">
<font color="#000000"><font face="Liberation Serif, Times New Roman, serif"><font size="4" style="font-size: 14pt"><i><b>Examining
interpreter code</b></i></font></font></font></p>
<p class="western">The debugger is part of this interpreter
implementation. So you can examine the debugger/interpreter by
running it all under your favorite debugger. It need not be gdb,
although that is what I used. So under your favorite debugger for C
code, follows the steps outlined below. 
</p>
<p class="western">The issue is shifting back and forth from one
debugger to the other. Here is how I did that...</p>
<p style="margin-bottom: 0in; line-height: 100%; page-break-after: avoid">
<b>Using tc debug UNDER your favorite C debugger</b></p>
<p style="margin-bottom: 0in; line-height: 100%; page-break-after: avoid">
<i><b>setup</b></i></p>
<ol>
	<li/>
<p class="western">In the tinyC code <font face="Courier 10 Pitch, serif">whatever.tc</font>
	declare a dummy variable, here called <font face="Courier 10 Pitch, serif">foo</font>,
	and put a dummy statement, <font face="Courier 10 Pitch, serif">foo=1</font>
	will do, in some function where you want to examine behavior.</p>
	<li/>
<p class="western">From within your favorite debugger start
	tinyc -d with your subject code, <font face="Courier 10 Pitch, serif">tinyc
	-d whatever.tc</font>. Note that startups under different debuggers
	differ. Mine, gdb, can only load  code at startup, and arguments are
	given later. But the intention is to get some breakpoints set, then
	get it all ready to run, but not yet running with the <font face="Courier 10 Pitch, serif">-c</font>
	and the <font face="Courier 10 Pitch, serif">whatever.tc</font>
	arguments.</p>
	<li/>
<p class="western">TinyC has a function gdb_b which does
	nothing but is invoked by the g command in debug. Set a breakpoint
	on this function, <font face="Courier 10 Pitch, serif">b gdb_b</font>.
	This enables getting out of tinyC's debugger back to your C
	debugger.</p>
	<li/>
<p class="western">Now start it all running, <font face="Courier 10 Pitch, serif">run
	-d pf.tc</font>, or your equivalent. The -d argument means you will
	see the tinyC debugger prompt, <font face="Courier 10 Pitch, serif">(tc-db)</font>.</p>
	<li/>
<p class="western">Now set a breakpoint on the step 1 dummy
	variable, foo, <font face="Courier 10 Pitch, serif">(tc-db) b foo</font>.
	All is arranged.</p>
</ol>
<p style="margin-bottom: 0in; line-height: 100%; page-break-after: avoid">
<i><b>session...</b></i></p>
<ol start="6">
	<li/>
<p class="western">Use the r command to start the interpreter
	running. <font face="Courier 10 Pitch, serif">(tc-db) r</font>. The
	interpreter takes over, and your tc program runs until it hits the
	reference to <font face="Courier 10 Pitch, serif">foo</font>
	wherever it was planted. At this point you are navigating the
	whatever.tc code, examining variables, setting more breakpoints,
	etc.</p>
	<li/>
<p class="western">When you get to a point where you want to
	examine interpreter code the g command invokes the do-nothing
	function <font face="Courier 10 Pitch, serif">g_db</font>.   Now you
	are in your C debugger examining the interpreter code. One, or
	perhaps a few (5 for gdb), single steps will get you out of g_db
	into interpreter code.</p>
</ol>
<p style="margin-top: 0.3in; margin-bottom: 0.1in; line-height: 100%">
<font face="Arial, serif"><font size="4" style="font-size: 14pt"><b>The
Test System</b></font></font></p>
<p class="western">A second executable, test, and its source code is
part of this project. It includes a battery of interpreter and
library tests. Most can be run in batch mode for quick regression
testing. A few others involving interaction must be run manually and
their outputs compared with documented good results.</p>
<p style="margin-top: 0.1in; margin-bottom: 0.1in; line-height: 100%">
<font color="#000000"><font face="Liberation Serif, Times New Roman, serif"><font size="4" style="font-size: 14pt"><i><b>Man
page</b></i></font></font></font></p>
<p class="western">NAME</p>
<p class="western">       test – A program that runs tests on tc.c
focusing on internals.</p>
<p class="western">SYNOPSIS</p>
<p class="western">       test [TESTNUMBER ...]</p>
<p class="western">DESCRIPTION</p>
<p class="western">With no arguments test runs all tests that require
no interaction, those with numbers less than 90. With numbers it runs
just those tests. The simpler tests have numbers in the 10's and
20's. Interaction numbers are in the 90s.</p>
<p class="western">MAKE COMMANDS</p>
<p class="western">These commands facilitate frequent tasks...</p>
<p class="western">	make dotest	–  Run all regression tests
producing a test_results file.</p>
<p class="western">	make diff	–  diff the test_results and
good_results files, results to stdout.</p>
<p class="western">	make keep	–  copy test_results to good_results</p>
<p style="margin-top: 0.1in; margin-bottom: 0.1in; line-height: 100%">
<font color="#000000"><font face="Liberation Serif, Times New Roman, serif"><font size="4" style="font-size: 14pt"><i><b>Usage
Notes</b></i></font></font></font></p>
<p class="western">As of this writing there are 46 tests organized
for simple regression testing. The are numbered 1 up but less than
90. Many are coded completely in the file test.c, but a few use files
stored in the directory testFiles. 
</p>
<p class="western">To run tests</p>
<p class="western">	./test [TESTNUMBER ...]</p>
<p class="western">With test numbers just those tests are run. If
none are given ALL tests are run. The test results are printed to
stdout. This is useful for just one or a few tests.</p>
<p class="western">A more convenient way to run all tests is...</p>
<p class="western">	<font face="Courier 10 Pitch, serif">make dotest</font></p>
<p class="western">which produces a file, test_results. Follow that
with...</p>
<p class="western">	<font face="Courier 10 Pitch, serif">make diff</font></p>
<p class="western">which does a unix diff on test_results against
good_results to stdout. I do not redirect that but let it print to my
terminal. Then scroll up/down to find issues. Every test prints a
header like...</p>
<p class="western">		TEST 16  09:11</p>
<p class="western">which includes a time stamp. So the different time
stamps for good_results vs test_results diff will always cause both
headers to print...</p>
<p class="western">		&lt; TEST 16  09:11</p>
<p class="western">		&gt; TEST 16  11:15</p>
<p class="western">The times themselves are irrelevant. Actual result
differences ARE relevant, and this simple trick identifies which test
needs attention. After doing a <font face="Courier 10 Pitch, serif">make
diff</font> scroll up and down and if all is cool it takes 5 seconds
to determine that.</p>
<p class="western">The good_results file is the real oracle for the
regressions. There used to be lots of pointers in the results which
would drift as code was changed, causing false differences. I removed
most of them, but some pr[..]'s still have differences, e.g.</p>
<p class="western">		164c164</p>
<p class="western">		&lt;  stack entry at 2: 0 A 1 pr[99]</p>
<p class="western">		&gt;  stack entry at 2: 0 A 1 pr[67]</p>
<p class="western">In test.c every test has a comment labeled &quot;Should
get…&quot; which also shows the expected results. For the
non-regression tests, in the 90's range, these comments are the
oracle. Run a specific test, do the interaction, and by eye compare
the test results with the Should get comment. Fortunately there are
presently only four such tests.</p>
<p style="margin-top: 0.1in; margin-bottom: 0.1in; line-height: 100%">
<font color="#000000"><font face="Liberation Serif, Times New Roman, serif"><font size="4" style="font-size: 14pt"><i><b>New
Tests</b></i></font></font></font></p>
<p class="western">Their are three basic coding styles for tests. 
</p>
<p class="western">The early tests are hard coded as cases in a giant
switch statement, test.c lines 120..750. A testSetup function is
available for initialization. Tests 1 through 29 and a few 30's use
this style.</p>
<p class="western">The second style reads a single statement from a
file and runs just that statement. Test 30 is an example. The single
statement can be compound, so in fact a substantial code fragment can
be done this way. The function testSetupFile does the initialization
including an optional library.tc load, and the file read.</p>
<p class="western">The third style is a variation on the second, but
the file is a whole program, with main[] and functions. The test case
code uses testSetupFile but also calls link(). Test 43 is an example.
But later tests use testWhole which calls link to initialize. That
call to link whether hard coded in the case code or from testWhole
distiguishes the third style from the second. 
</p>
<p style="margin-top: 0.3in; margin-bottom: 0.1in; line-height: 100%">
<font face="Arial, serif"><font size="4" style="font-size: 14pt"><b>Machine
Calls</b></font></font></p>
<p class="western">Machine calls are coded in C but can be called
directly from a tinyC program. Best practice is to wrap the MC in a
library or private routine. They are numbered in three ranges:
originals (1977), new (2017),  user defined. Add your personal MCs to
the third range, numbered 201 up. 
</p>
<p class="western">The arguments are parsed and stacked, with the
last argument being the MC number. For example…</p>
<p class="egcode-western">	/* Put a character to the terminal</p>
<p class="egcode-western">	putchar char c [</p>
<p class="egcode-western">		if(c==0)c='&quot;'</p>
<p class="egcode-western">		MC c,1</p>
<p class="egcode-western">	]</p>
<p class="western">The implementation is…</p>
<p class="egcode-western">	McList origList[] = 
</p>
<p class="egcode-western">		{ &amp;Mpc, &amp;Mgch, &amp;bar, &amp;bar,
&amp;bar</p>
<p class="egcode-western">		...</p>
<p class="egcode-western">		};</p>
<p class="western">and</p>
<p class="egcode-western">	int Mpc(int nargs, int *args)</p>
<p class="egcode-western">	{</p>
<p class="egcode-western">	    printf(&quot;%c&quot;, *args);</p>
<p class="egcode-western">	}</p>
<p class="western">MC 1 acquires its number by its placement in the
<font face="Courier 10 Pitch, serif">origList</font> array of
function addresses. Its implementation routine is named there. The MC
infrastructure pops all the args into <font face="Courier 10 Pitch, serif">nargs,
*args</font>. And it pushes whatever your implementation returns as
an int.</p>
<p class="western">Follow this model, and build yourself a nice
library.</p>
<p style="margin-top: 0.3in; margin-bottom: 0.1in; line-height: 100%">
<font face="Arial, serif"><font size="4" style="font-size: 14pt"><b>Sample
code</b></font></font></p>
<p class="western">Find sample tc programs in...</p>
<p class="western">  
<font face="Courier 10 Pitch, serif"><a href="https://github.com/tgibson37/tiny-c/tree/master/SamplePrograms">https://github.com/tgibson37/tiny-c/tree/master/SamplePrograms</a></font></p>
<p class="western">Currently just piranha fish (pf.tc).</p>
<p style="margin-top: 0.3in; margin-bottom: 0.1in; line-height: 100%">
<font face="Arial, serif"><font size="4" style="font-size: 14pt"><b>Appendix</b></font></font></p>
<p style="margin-top: 0.1in; margin-bottom: 0.1in; line-height: 100%">
<font color="#000000"><font face="Liberation Serif, Times New Roman, serif"><font size="4" style="font-size: 14pt"><i><b>A.
tiny-C stories</b></i></font></font></font></p>
<p class="western">Find these in  <font color="#000080"><span lang="zxx"><u><a href="https://tinyurl.com/tinycstories">https://tinyurl.com/tinycstories</a></u></span></font>.</p>
<p style="margin-top: 0.1in; margin-bottom: 0.1in; line-height: 100%">
<font color="#000000"><font face="Liberation Serif, Times New Roman, serif"><font size="4" style="font-size: 14pt"><i><b>B.
Implementation Notes</b></i></font></font></font></p>
<p style="margin-bottom: 0in; line-height: 100%; page-break-after: avoid">
<b>Installation</b></p>
<p style="margin-bottom: 0in; line-height: 100%; page-break-after: avoid">
<br/>

</p>
<p class="western">The linux executable, <font face="Courier 10 Pitch">tc</font>,
is part of the download, so a compile of source may not be necessary.
But it is compiled and tested on my particular linux. You may have to
tweak things like install directories, even executable names. 'tc'
for example is a mint linux facility…</p>
<p style="margin-left: 0.3in; margin-right: 0.3in; text-indent: 0.02in; margin-top: 0.1in; margin-bottom: 0.1in; font-weight: normal; line-height: 100%">
<font face="Arial, serif"><font size="2" style="font-size: 9pt">TC(8)
                                Linux                                
TC(8)</font></font></p>
<p style="margin-left: 0.3in; margin-right: 0.3in; text-indent: 0.02in; margin-top: 0.1in; margin-bottom: 0.1in; font-weight: normal; line-height: 100%">
<font face="Arial, serif"><font size="2" style="font-size: 9pt">NAME</font></font></p>
<p style="margin-left: 0.3in; margin-right: 0.3in; text-indent: 0.02in; margin-top: 0.1in; margin-bottom: 0.1in; font-weight: normal; line-height: 100%">
       <font face="Arial, serif"><font size="2" style="font-size: 9pt">tc
- show / manipulate traffic control settings</font></font></p>
<p class="western">so I use <font face="Courier 10 Pitch">./tc</font>
in my development directory for a freshly compiled version, and <font face="Courier 10 Pitch">tinyc</font>
for an installed version. 
</p>
<p class="western">A makefile builds both <font face="Courier 10 Pitch">tc</font>
and <font face="Courier 10 Pitch">test</font> executables using <font face="Courier 10 Pitch">gcc</font>
with <font face="Courier 10 Pitch">cflags</font> appropriate for
debugging (-<font face="Courier 10 Pitch">g</font>). Also a shell
script that uses the compiler <font face="Courier 10 Pitch">tcc</font>
for just the tc executable. Either compiler is fine. CURRENTLY I am
clearing warning flags, so ignore these for now. Other C compilers
may stumble until I get these cleared.</p>
<p class="western">The makefile's <font face="Courier 10 Pitch">install</font>
target has tc as its only dependancy so it will compile/link if
necessary. But mainly it copies two files into your <font face="Courier 10 Pitch">/usr/local</font>
directory changing the name from tc to tinyc. You may want to tweak
the install locations in the makefile, chmod the tinyc subdirectories
<font face="Courier 10 Pitch">bin/tinyc</font> and <font face="Courier 10 Pitch">share/tinyc</font>
 so you instead of root own them. (Not bin and share, just the tinyc
subdir's.)</p>
<p class="western">CURRENTLY the 4 major data areas (<font face="Courier 10 Pitch">fun,
var</font><font face="Courier 10 Pitch">tab</font><font face="Courier 10 Pitch">,
stack, pr</font>) are sized generously but fixed at compile time. A
better technique, of course, is to malloc these with defaults and a
run time override mechanism (settings). Check these sizes in the
header <font face="Courier 10 Pitch">tc.h</font> if this becomes an
issue.</p>
<p style="margin-bottom: 0in; line-height: 100%; page-break-after: avoid">
<b>Porting Considerations </b>
</p>
<p style="margin-bottom: 0in; line-height: 100%; page-break-after: avoid">
<br/>

</p>
<p class="western">The 8080 is a byte oriented typeless machine. It
does have some 16 bit instructions treating a pair of 8 bit registers
as a 16 bit register, and that is as close as it gets to having
types. A 16 bit datum may be an integer or it may be an address, a
pointer. Neither the hardware nor the assembler knows the difference
or cares. It is how they get used that mattered. This was reflected
in the 8080 interpreter code.</p>
<p class="western">C is typed. Reading the 8080 code and reverse
engineering into C code meant adding this typing information into the
code. But lots of the 8080 code simply did not use the datum, just
passed it along. The 8080 code carries type information alongside
each datum or array in the entries to the stack and the variable
table. Alongside are type, class, and len which describe the type.
Data is separated from this only when it is going into code that
implicitly knows the type. A good example is <font face="Courier 10 Pitch, serif">toptoi()</font>,
tc.c line 130. It returns an int which may in fact be a tiny-c char,
int, or array reference (pointer). In C, char and int can be assigned
to each other without casting. And for 32 bit compilers, so can
pointers and ints. But when the datum ultimately gets used, its
tiny-c type must be known. Toptoi is typeless, but can only be used
where the type expected is known.</p>
<p class="western">Entries in both the calculation stack, <font face="Courier 10 Pitch, serif">stack</font>,
and the value storage area, <font face="Courier 10 Pitch, serif">pr</font>
(beyond the tc code), are typeless values, just bytes. My
implementation uses a union of int, char, and void* into one typeless
container, <font face="Courier 10 Pitch, serif">union stuff</font>. 
See tc.h lines 40..68. Both <font face="Courier 10 Pitch, serif">stackEntry</font>
and the <font face="Courier 10 Pitch, serif">variableEntry</font>
have union stuff to hold values. Datum moved between stuff and C
variables obey type, but once in stuff they can be passed around in a
typeless manner. That technique made it easier for me to translate
8080 code into C. 
</p>
<p class="western">Awareness of this design issue is probably the
most important fact not answered by inspection of the code.</p>
<p class="western">One anomoly: For some reason my compiler compiled
64 bit pointers. The high 32 bits never get used, just space for them
compiled in. Toptoi returns a 32 bit int, which is often cast to a
char* or int*. It works. Why my compiler allocates those 32 useless
extra bits I do not know. Be warned this may affect a porting effort.
</p>
<p style="margin-bottom: 0in; line-height: 100%; page-break-after: avoid">
<b>My environment</b></p>
<p class="western">I built this version of tiny-C on mint linux using
these tools:</p>
<p class="western">    - gnu's c compiler, gcc ubuntu 4.8.4-2</p>
<p class="western">    - gnu's make 3.81, makefile</p>
<p class="western">The makefile has all the technical specs. For
example this line...</p>
<p class="western">    <font face="Courier 10 Pitch, serif">CFLAGS =
-w -g -ansi -I /usr/lib/syslinux/com32/include/</font></p>
<p class="western">defines all the dash flags used on most
compile/link.</p>
<p class="western">One anomaly. Two files would not compile with
those flags, I don't know why...</p>
<p class="western">    - time.c</p>
<p class="western">    - FileRead.c</p>
<p class="western">But they compile and work fine with NO flags
except <font face="Courier 10 Pitch, serif">-c</font>, just pure <font face="Courier 10 Pitch, serif">gcc
-c time.c</font>, for example. And the link phase found their objects
just fine. The makefile handles this anomaly.</p>
<p class="western">Make install just copies the executable and
library.tc files to where I want them on my linux box. Change this to
suit your environment.</p>
<p class="western">I am not familiar with either Windows, or Apple's
OSx. I assume they have build facilities not too far removed from my
supplied make. So if you are porting my work to another environment
you may have a bit of work to port the makefile, especially the
compile flags.</p>
<p style="margin-top: 0.1in; margin-bottom: 0.1in; line-height: 100%">
<font color="#000000"><font face="Liberation Serif, Times New Roman, serif"><font size="4" style="font-size: 14pt"><i><b>Archive</b></i></font></font></font></p>
<p style="margin-bottom: 0in; line-height: 100%; page-break-after: avoid">
<b>Status</b></p>
<p class="western">This is STATUS.txt in
<font face="Courier 10 Pitch, serif"><a href="https://github.com/tgibson37/tiny-c">https://github.com/tgibson37/tiny-c</a></font>.</p>
<p style="margin-bottom: 0in; line-height: 100%; page-break-after: avoid">
<b>License to this work</b></p>
<p class="western">This is LICENSE.txt in
<font face="Courier 10 Pitch, serif"><a href="https://github.com/tgibson37/tiny-c">https://github.com/tgibson37/tiny-c</a></font>.</p>
<p style="margin-bottom: 0in; line-height: 100%; page-break-after: avoid">
<b>8080 code</b></p>
<p class="western">This is tc.asm in
<font face="Courier 10 Pitch, serif"><a href="https://github.com/tgibson37/tiny-c">https://github.com/tgibson37/tiny-c</a></font>.</p>
<p style="margin-bottom: 0in; line-height: 100%; page-break-after: avoid">
<b>My Development Environment</b></p>
<p class="western">This is MY_ENVIRONMENT.txt
<font face="Courier 10 Pitch, serif"><a href="https://github.com/tgibson37/tiny-c">https://github.com/tgibson37/tiny-c</a></font>.</p>
<p style="margin-bottom: 0in; line-height: 100%; page-break-after: avoid">
<br/>

</p>
<p style="margin-top: 0.3in; margin-bottom: 0.1in; line-height: 100%">
<font face="Arial, serif"><font size="4" style="font-size: 14pt"><b>Background</b></font></font></p>
<p class="western">This work started out as a pure nostalgia project.
In 1977 I designed and coded an 8080 software product, tiny-C, an
interpreter for a subset of the C computer programming language. To
this day I look back on tiny-C as one of my most fun technical
accomplishments. 
</p>
<p class="western">From time to time I indulge in looking back to my
more youthful projects, and one day browsing on-line what a pleasant
surprise: I discovered the facebook site “Not just tiny-C,”
hosted by Lee Bradley. I joined, of course, and contributed eight
very short “tiny-C stories” plus a few comments from time to
time. The stories are in this writing, Appendix A.</p>
<p class="western">My browsing included an 8080 CPM I had written in
1977-78, and reading a bit of it was fun. Forty year old assembler
code, and not a few mysteries. Soon I was taking notes. Soon the
notes looked like C pseudo-code. And soon I was typing it in, and
even compiling small segments. I was getting sucked into a larger
project. Soon I was working towards a full implementation of tiny-C
in C.</p>
<p class="western">Another motivation was a question addressed to me
on Not Just tiny-C, did a licensable version of tiny-C exist? The
answer was basically “no”. I had formed a partnership, Tiny-C
Associates, and my partner, Scott Guthery and I had developed the
marketable version, all copyrighted by the partnership. That
Association no longer exists, and its properties are all “orphans”.
But Scott and I agreed each could use the properties independently.
He and I both wrote books about tiny-C, his being by far the better.
But a cleanly licensable version needs more than that agreement. The
easiest solution would be for us to reconnect and agree to GPL all
the associations properties. But my attempts to locate Scott have not
yet succeeded. 
</p>
<p class="western">But one property, my 8080 source code, is
copyrighted by myself, and the copyright is right in the source code.
That was my starting point for my full implementation.</p>
<p style="margin-top: 0.1in; margin-bottom: 0.1in; line-height: 100%">
<font color="#000000"><font face="Liberation Serif, Times New Roman, serif"><font size="4" style="font-size: 14pt"><i><b>Links</b></i></font></font></font></p>
<p class="western">Where to find this project:   
<font color="#000080"><span lang="zxx"><u><a href="https://github.com/tgibson37/tiny-c">https://github.com/tgibson37/tiny-c</a></u></span></font></p>
<p class="western">Lee Bradley's “Not just tiny C”:   
<font color="#000080"><span lang="zxx"><u><a href="https://www.facebook.com/groups/299317782048/">https://www.facebook.com/groups/299317782048/</a></u></span></font></p>
<p class="western"><br/>
<br/>

</p>
</body>
</html>